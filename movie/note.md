# CI/CD 構築

主に Github Actions を利用します。

構築の際、以下のことを考慮して行います。

- そのリポジトリが Public か Private か
  <!-- - いわゆる GPL 系ライセンスのライブラリを利用しているかどうかの確認をするかしないか -->
- Self-Hosted Runner を利用するかどうか
- 機密情報を含むファイルがコミットに含まれていたかどうかの検知(.env 等)
- ライブラリの自動更新をかけるかどうか
  <!-- - どのライブラリは自動更新から除外するか(セキュリティリスク考慮) -->
- フロントエンド CD を行う場合、CloudFront 等の CDN キャッシュの取り扱いはどうするか
- CD の際の機密情報や認証はどうするのか
- ブランチ保護ルールはどのようにするか

モノレポでの開発を行う場合、以下のようになります。
![CI](https://misskey.na2na.dev/media/media/595bb658-4c63-49e9-b380-de533a4b7f3c.png)

# バックエンド構築

PHP/Laravel や Node.js/Express, NestJS を利用してバックエンドを構築します。

構築の際、以下のことを考慮して行います。

- CORS 設定
  <!-- - 無意味に\*をつけないこと。開発中でも同じ -->
- 使用するフレームワークのお作法に乗っ取った設計をすること。
  - 例えば、Laravel ならばバリデーションは FormRequest に移譲する等、コントローラが賢くなりすぎないように
  - 例えば Eloquent なら必要になるまで query や select を避ける。型の恩恵を最大限受けよう。
- テスタブルな実装をしよう
- 可能ならスキーマ駆動でやっていきたい。
  <!-- - 型の恩恵を最大限受けよう -->
- Linter 等の静的解析で防げるものは防ぎましょう

# フロントエンド構築

主に Vite/React + TypeScript を利用しています。

主に以下のことを考えています。

- 概念を増やしすぎない
  <!-- - 実装時に考慮すべき箇所が増えるため -->
- いわゆる責務の分離を徹底する
  <!-- - 親子になるコンポーネントがあったとして、親が子の状態を知っているべきかどうか、など -->
- テスタブルな実装をしよう

  - 例えばフック類をまとめたカスタムフック化して別ファイルに切り出すなど。
  - カスタムフックにコンポーネントを渡す際に`useHooks(props, Hoge)`と渡して、useHooks の中で以下のようにして呼び出すようにしよう。コンポーネントのモックができてお得です。

  ```tsx
  React.createElement(Hoge, {
    onClick: handleClick,
  });
  ```

- 可能ならスキーマ駆動で
  <!-- - 型の恩恵を最大限受けよう -->
- Linter 等の静的解析で防げるものは防ぎましょう

# インフラ構築

よく使うのは AWS です。
以下のことを意識しています。

- ロールやポリシーを適切に扱いましょう
- 予算はしっかりと管理して、必要ならばアラートをかけましょう
- メトリクスの監視をして異常があれば通知を出しましょう
- IaC する場合は
  - tflint 等の静的解析で防げるものは防ぎましょう
  - tfstate を S3 に置く場合は、バージョニングを有効にしましょう。また、排他ロックもしましょう。
